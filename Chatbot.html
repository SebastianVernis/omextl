<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente OMEXTL</title>
    <style>
        /* (El CSS de aquí es similar al anterior, pero con colores ajustados y el botón de cierre) */
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #ffffff;
        }

        .chat-header {
            background-color: #1a1a1a;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* --- Estilo para el botón de Cierre (X) --- */
        #close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        
        .chat-window { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #f9f9f9;}
        .message { padding: 12px 18px; border-radius: 20px; max-width: 80%; line-height: 1.5; }
        .user-message { background-color: #e9e9eb; color: #000; align-self: flex-end; border-bottom-right-radius: 5px; }
        .bot-message { background-color: #f0f0f0; border: 1px solid #e0e0e0; align-self: flex-start; border-bottom-left-radius: 5px; }
        .chat-input { display: flex; padding: 15px; border-top: 1px solid #e0e0e0; background-color: #fff; }
        .chat-input input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 12px 18px; font-size: 16px; }
        .chat-input button { background-color: #1a1a1a; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; margin-left: 10px; cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>

    <div class="chat-header">
        <span>Asistente OMEXTL</span>
        <button id="close-btn">&times;</button>
    </div>

    <div class="chat-window" id="chat-window">
        <div class="message bot-message">Hola, soy el asistente virtual de OMEXTL. ¿Cómo puedo ayudarte?</div>
    </div>

    <div class="chat-input" id="chat-input-area">
        <input type="text" id="user-input" placeholder="Escribe tu consulta...">
        <button id="send-btn">➤</button>
    </div>

    <script>
        // La lógica del chatbot (las respuestas y el envío de mensajes) se mantiene igual.
        // Ahora, la comunicación para cerrar se manejará desde el script principal.
        const closeBtn = document.getElementById('close-btn');
        
        // Cuando se hace clic en el botón de cerrar, enviamos un mensaje a la página padre.
        closeBtn.addEventListener('click', () => {
            // "parent" se refiere a la ventana que contiene el iframe (index.html)
            // "postMessage" es la forma segura de comunicar iframes con su página contenedora.
            parent.postMessage('close-chatbot', '*'); 
        });
        (() => {
          const chatMessages = document.getElementById('chatMessages');
      const chatForm = document.getElementById('chatForm');
      const userInput = document.getElementById('userInput');
      const clearChatBtn = document.getElementById('clearChatBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      // --- HISTORIAL DEL CHAT ---
      // Se inicia con un mensaje de sistema para darle contexto al bot.
      let chatHistory = [{
          role: "user",
          parts: [{ text: "1. Identidad y Personalidad: Eres OMEX-IA, el asistente virtual experto de OMEX TL, una empresa de logística y transporte en México. Tu personalidad es profesional, eficiente y confiable. Tu objetivo principal es ayudar a los visitantes del sitio web a entender los servicios de la empresa, facilitar el contacto y responder preguntas frecuentes. Directrices Fundamentales de Comunicación: Idioma: Te comunicas exclusivamente en español de México. Tono de Voz: Mantén siempre un tono servicial, claro y conciso. Eres un experto que inspira confianza. Eslogan Oficial: Tu lema principal es 'Tu carga segura, nuestro compromiso total.'Estrategia sobre Aliados: Nunca reveles los nombres de los socios o aliados logísticos. En su lugar, refiérete a ellos de forma general como 'nuestra red de aliados estratégicos de confianza' o 'nuestra robusta red logística'. OMEX TL es siempre el único proveedor y punto de contacto para el cliente. Base de Conocimiento (Knowledge Base) Información de la Empresa:Misión: Brindar soluciones logísticas confiables, seguras y adaptadas a las necesidades de cada cliente, impulsando operaciones ágiles y efectivas a través de procesos bien estructurados, tecnología de vanguardia y un equipo comprometido con la excelencia en el servicio. Visión: Consolidarnos como una empresa referente en logística a nivel nacional, reconocida por su capacidad de respuesta, su enfoque en la mejora continua y su firme compromiso con la calidad, la seguridad y la satisfacción total del cliente en cada etapa del proceso. Portafolio de Servicios: Transporte FTL (Full Truckload) y LTL (Less Than Truckload): Ofrecemos soluciones de carga completa y consolidada en caja seca. FTL garantiza exclusividad y rapidez, mientras que LTL permite compartir espacio para reducir costos. Transporte de Carga Refrigerada: Contamos con unidades con control de temperatura para garantizar la cadena de frío de productos perecederos y sensibles. Transporte en Camionetas: Disponemos de unidades dedicadas desde 1.5 hasta 3.5 toneladas, ideales para entregas directas, última milla y servicios flexibles. Custodia de Mercancías: Brindamos servicio a nivel nacional, con opciones de custodia armada o sencilla para proteger cargas de alto valor. Seguros de Mercancía: Gestionamos pólizas con cobertura amplia para unidades, así como para la carga y descarga, protegiendo su inversión. Maniobras Especializadas: Realizamos el servicio de carga y descarga, incluyendo el uso de maquinaria pesada. (Nota: Este servicio está sujeto a disponibilidad y requiere solicitud previa). Logística de Aduanas: Gestionamos el ingreso de mercancía en los principales puertos marítimos del país: Veracruz, Manzanillo y Lázaro Cárdenas. Monitoreo GPS 24/7: Todas nuestras unidades cuentan con seguimiento en tiempo real y funciones de seguridad avanzadas como paro de motor. Flotilla: Urvan / Van Mediana: 5 unidades. Uso: Paquetería de mayor volumen, rutas urbanas. Tornado Van: 1 unidad. Uso: Última milla, recolecciones, paquetería estándar. Attitude / Sedán: 1 unidad. Uso: Mensajería, paquetería pequeña, documentos. Lobo / Pickup: 1 unidad. Uso: Carga pesada, materiales voluminosos. Información de Contacto: Email: contacto@omextl.com Teléfono / WhatsApp: 56 3594 2337 Dirección: Av. Homero 229, Piso 1, Int. 104-A, Polanco V Secc, Miguel Hidalgo, CDMX, 11560. Sitio Web: www.omextl.com Redes Sociales: LinkedIn: https://www.linkedin.com/company/omex-tl/ YouTube: https://www.youtube.com/channel/UC3B2QJgrN48fNgPC4e0e_-Q Instagram: https://www.instagram.com/o.mextl/ Flujos de Conversación (Ejemplos de Comportamiento) Si el usuario quiere cotizar: Responde con entusiasmo: '¡Claro que sí! Con gusto te ayudo. Para darte la cotización más precisa, te invito a contactarnos directamente por correo a contacto@omextl.com o a través de nuestro WhatsApp 56 3594 2337, donde un especialista te atenderá de inmediato.' Si el usuario pide ayuda o tiene una queja: Responde con empatía: 'Entiendo. Lamento que estés experimentando un problema. Para darte la mejor atención, por favor contáctanos por teléfono o WhatsApp al 56 3594 2337 y un miembro de nuestro equipo te ayudará a resolverlo.' Si el usuario pregunta por un servicio específico: Proporciona la descripción del servicio basada en el portafolio de esta Gema de Marca. Finaliza siempre con una invitación a contactar para más detalles: 'Si te gustaría una cotización o más información, no dudes en escribirnos a contacto@omextl.com.'Al finalizar cualquier interacción exitosa: Agradece al usuario y cierra con el eslogan: 'Fue un placer ayudarte. En OMEX TL, tu carga segura es nuestro compromiso total. ¡Que tengas un excelente día!' Procuraras siempre ser breve sin omitir informacion, siempre utilizaras emojis para complementar de manera visual tus respuestas recuerda que tú formato es solo de texto, por lo que evitarás colocar hipervínculos o negritas, trabajaras sobre texto simple y emojis. Tu primera directriz es obtener los datos del cliente, por lo que en tu presentación deberás solicitarlos y si el cliente te ignora y hace una pregunta, deberás persuadir para obtenerlos, solicitando nombre, correo, servicio de interés y número telefónico."
 }]
      }, {
          role: "model",
          parts: [{ text: "¡Entendido! Seré un asistente de IA útil y amigable." }]
      }, {
          role: "user",
          parts: [{ text: "Dime quien eres." }]
      }]
      // --- FUNCIONES DEL CHAT ---

      /**
       * Crea y añade un mensaje a la interfaz del chat.
       * @param {string} text - El contenido del mensaje.
       * @param {('user'|'bot')} sender - Quién envía el mensaje.
       */
      function createMessage(text, sender = 'user') {
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

        const messageBubble = document.createElement('div');
        messageBubble.classList.add(
          'max-w-[75%]', 'px-4', 'py-2', 'rounded-lg', 
          'whitespace-pre-wrap', 'break-words'
        );
        
        if (sender === 'user') {
          messageBubble.classList.add('bg-indigo-600', 'text-white', 'rounded-br-none');
        } else {
          messageBubble.classList.add('bg-gray-200', 'text-gray-900', 'rounded-bl-none');
        }

        messageBubble.textContent = text;
        messageWrapper.appendChild(messageBubble);
        chatMessages.appendChild(messageWrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
      }

      /**
       * Muestra un mensaje de error en la interfaz.
       * @param {string} message - El mensaje de error a mostrar.
       */
      function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.classList.add('text-center', 'text-red-600', 'text-sm', 'mt-2', 'font-semibold');
        errorDiv.textContent = message;
        chatMessages.appendChild(errorDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      /**
       * Envía el mensaje del usuario a la API de Gemini y obtiene una respuesta.
       * @param {string} message - El mensaje del usuario.
       * @returns {Promise<string|null>} La respuesta del bot o null si hay un error.
       */
      async function getBotResponse(message) {
        // Añade el mensaje del usuario al historial para mantener el contexto
        chatHistory.push({ role: "user", parts: [{ text: message }] });

        const apiKey = "AIzaSyCUHC77APrs0ndHZ3jZZJgpWt8nV75rxFI"; // Dejar en blanco, se gestiona automáticamente.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        const payload = {
          contents: chatHistory,
          // Opcional: configuraciones de seguridad y generación
          generationConfig: {
            temperature: 0.7,
            topP: 1,
            topK: 1,
            maxOutputTokens: 2048,
          },
        };

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorBody = await response.json();
            throw new Error(`Error en la API: ${errorBody.error?.message || response.statusText}`);
          }

          const result = await response.json();
          
          if (result.candidates && result.candidates.length > 0) {
            const botMessage = result.candidates[0].content.parts[0].text;
            // Añade la respuesta del bot al historial
            chatHistory.push({ role: "model", parts: [{ text: botMessage }] });
            return botMessage;
          } else {
            throw new Error('La respuesta de la API no contiene texto.');
          }

        } catch (error) {
          console.error('Error al comunicarse con la API de Gemini:', error);
          showError('No se pudo obtener una respuesta del bot. Inténtalo de nuevo.');
          // Si la llamada falla, elimina el último mensaje del usuario del historial
          chatHistory.pop(); 
          return null;
        }
      }

      // --- MANEJADORES DE EVENTOS ---

      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        createMessage(message, 'user');
        userInput.value = '';
        userInput.disabled = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Icono de carga

        const response = await getBotResponse(message);

        if (response) {
          createMessage(response, 'bot');
        }

        userInput.disabled = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        userInput.focus();
      });

      clearChatBtn.addEventListener('click', () => {
        chatMessages.innerHTML = '';
        // Opcional: Restablecer el historial si es necesario
        chatHistory = chatHistory.slice(0, 2); 
        // Añadir de nuevo el mensaje de bienvenida
        createMessage('¡Hola! Soy un asistente de IA. ¿En qué puedo ayudarte hoy?', 'bot');
        userInput.focus();
      });

      // --- INICIALIZACIÓN ---
      window.addEventListener('load', () => {
        userInput.focus();
      });
    })();
  </script>
</body>
</html>

